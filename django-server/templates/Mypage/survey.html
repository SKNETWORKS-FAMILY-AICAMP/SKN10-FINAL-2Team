{% extends 'Mypage/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/Mypage/header.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/Mypage/survey.css' %}">
<style>
/* Nadpisujemy style, aby upewnić się, że są zastosowane */
.survey-container {
    position: absolute !important;
    width: 468px !important;
    height: 840px !important;
    left: calc(50% - 468px/2) !important;
    top: 180px !important;
    background: #FFFFFF !important;
    box-shadow: 0px 0px 8px rgba(0, 0, 0, 0.25) !important;
    border-radius: 6px !important;
    padding: 20px !important;
    overflow-y: auto !important;
}

.initial-survey-page {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    padding: 20px !important;
    margin-top: 20px !important;
}

.start-survey-btn, .next-btn {
    width: 436px !important;
    height: 48px !important;
    background: #EADCA6 !important;
    border-radius: 6px !important;
    border: none !important;
    font-family: 'Pretendard' !important;
    font-style: normal !important;
    font-weight: 700 !important;
    font-size: 16px !important;
    line-height: 24px !important;
    color: #FFFFFF !important;
    cursor: pointer !important;
    transition: background-color 0.2s !important;
    margin: 0 auto !important;
}

.start-survey-btn:hover, .next-btn:hover {
    background: #DCA628 !important;
}

.survey-title {
    font-family: 'Pretendard' !important;
    font-style: normal !important;
    font-weight: 700 !important;
    font-size: 24px !important;
    line-height: 29px !important;
    text-align: center !important;
    color: #DDC66F !important;
    margin-bottom: 20px !important;
    padding-top: 20px !important;
}

.survey-desc {
    font-family: 'Pretendard' !important;
    font-style: normal !important;
    font-weight: 400 !important;
    font-size: 16px !important;
    line-height: 24px !important;
    color: #31444E !important;
    margin-bottom: 30px !important;
    text-align: center !important;
    max-width: 400px !important;
}

.question-group {
    margin-bottom: 30px !important;
    padding: 0 20px !important;
}

.question-group h2 {
    font-family: 'Pretendard' !important;
    font-style: normal !important;
    font-weight: 700 !important;
    font-size: 18px !important;
    line-height: 24px !important;
    color: #31444E !important;
    margin-bottom: 20px !important;
}

.option-row {
    display: flex !important;
    flex-direction: column !important;
    gap: 12px !important;
    margin-bottom: 20px !important;
}

.option-box {
    width: 100% !important;
    height: 48px !important;
    background: #FFFFFF !important;
    border: 1px solid #E6E6E6 !important;
    border-radius: 6px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    cursor: pointer !important;
    transition: all 0.2s !important;
}

.option-box:hover {
    border-color: #EADCA6 !important;
    background: #FDFBF5 !important;
}

.option-box.active {
    border-color: #EADCA6 !important;
    background: #FDFBF5 !important;
}

.option-box span {
    font-family: 'Pretendard' !important;
    font-style: normal !important;
    font-weight: 500 !important;
    font-size: 16px !important;
    line-height: 24px !important;
    color: #31444E !important;
}

input[type="number"] {
    width: 100% !important;
    height: 48px !important;
    background: #FFFFFF !important;
    border: 1px solid #E6E6E6 !important;
    border-radius: 6px !important;
    padding: 0 16px !important;
    font-family: 'Pretendard' !important;
    font-style: normal !important;
    font-weight: 500 !important;
    font-size: 16px !important;
    line-height: 24px !important;
    color: #31444E !important;
    margin-bottom: 20px !important;
}

input[type="number"]:focus {
    outline: none !important;
    border-color: #EADCA6 !important;
}

.error-message {
    text-align: center !important;
    color: #FF4B4B !important;
    padding: 20px !important;
}

.error-message ul {
    list-style: none !important;
    padding: 0 !important;
    margin: 10px 0 !important;
}

.error-message li {
    margin: 5px 0 !important;
    font-size: 14px !important;
}

.survey-buttons {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    margin-top: 20px;
}

.prev-btn, .next-btn {
    width: 213px !important;
    height: 48px !important;
    background: #EADCA6 !important;
    border-radius: 6px !important;
    border: none !important;
    font-family: 'Pretendard' !important;
    font-style: normal !important;
    font-weight: 700 !important;
    font-size: 16px !important;
    line-height: 24px !important;
    color: #FFFFFF !important;
    cursor: pointer !important;
    transition: background-color 0.2s !important;
}

.prev-btn:hover, .next-btn:hover {
    background: #DCA628 !important;
}

.error-message {
    color: #FF4B4B;
    font-size: 14px;
    margin-top: 10px;
    text-align: center;
    display: none;
}
</style>
{% endblock %}

{% block content %}
  <div class="survey-container">
    <div class="initial-survey-page">
      <h1 class="survey-title">건강 설문조사</h1>
      <p class="survey-desc">안녕하세요, {{ user.name }}님! 설문조사를 통해 건강 상태와 생활 습관을 바탕으로 필요한 영양제를 추천해 드립니다.</p>
      <button type="button" class="start-survey-btn">시작하기</button>
    </div>

    <form method="post" class="survey-form" style="display: none;">
      {% csrf_token %}

      {% if survey_questions %}
        {% for question in survey_questions.questions %}
        <div class="question-group" style="display: none;">
          <h2>{{ question.text }}</h2>
          {% if question.type == 'select' %}
          <input type="hidden" name="{{ question.name }}" value="">
          <div class="option-row">
            {% for option in question.options %}
            <div class="option-box" data-value="{{ option }}" data-input="{{ question.name }}"><span>{{ option }}</span></div>
            {% endfor %}
          </div>
          {% elif question.type == 'number' %}
          <input type="number" name="{{ question.name }}" placeholder="숫자 입력" required>
          {% endif %}
          <div class="error-message">이 질문에 답변해주세요.</div>
          <div class="survey-buttons">
            {% if not forloop.first %}
            <button type="button" class="prev-btn">이전</button>
            {% else %}
            <div></div>
            {% endif %}
            {% if not forloop.last %}
            <button type="button" class="next-btn">다음</button>
            {% else %}
            <button type="submit" class="next-btn">제출하기</button>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="error-message">
          <p>설문 질문을 불러오는 중 오류가 발생했습니다.</p>
          {% if debug_info %}
          <p>디버그 정보:</p>
          <ul>
            <li>파일 경로: {{ debug_info.file_path }}</li>
            <li>질문 개수: {{ debug_info.questions_count }}</li>
          </ul>
          {% endif %}
        </div>
      {% endif %}
    </form>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const initialPage = document.querySelector('.initial-survey-page');
  const surveyForm = document.querySelector('.survey-form');
  const startButton = document.querySelector('.start-survey-btn');
  const questionGroups = document.querySelectorAll('.question-group');
  let currentQuestionIndex = 0;

  console.log('Question groups:', questionGroups.length);

  startButton.addEventListener('click', function() {
    initialPage.remove();
    surveyForm.style.display = 'block';
    if (questionGroups.length > 0) {
      showQuestion(currentQuestionIndex);
    } else {
      console.error('No question groups found');
    }
  });

  function showQuestion(index) {
    console.log('Showing question:', index);
    questionGroups.forEach((group, i) => {
      group.style.display = i === index ? 'block' : 'none';
    });
  }

  function validateQuestion(index) {
    const currentGroup = questionGroups[index];
    const hiddenInput = currentGroup.querySelector('input[type="hidden"]');
    const numberInput = currentGroup.querySelector('input[type="number"]');
    const errorMessage = currentGroup.querySelector('.error-message');
    
    if (hiddenInput && !hiddenInput.value) {
      errorMessage.style.display = 'block';
      return false;
    } else if (numberInput && !numberInput.value) {
      errorMessage.style.display = 'block';
      return false;
    }
    
    errorMessage.style.display = 'none';
    return true;
  }

  surveyForm.querySelectorAll('.next-btn').forEach(button => {
    if (button.type === 'button') {
      button.addEventListener('click', function() {
        if (!validateQuestion(currentQuestionIndex)) {
          return;
        }
        currentQuestionIndex++;
        if (currentQuestionIndex < questionGroups.length) {
          showQuestion(currentQuestionIndex);
        }
      });
    }
  });

  surveyForm.querySelectorAll('.prev-btn').forEach(button => {
    button.addEventListener('click', function() {
      currentQuestionIndex--;
      if (currentQuestionIndex >= 0) {
        showQuestion(currentQuestionIndex);
      }
    });
  });

  document.querySelectorAll('.option-box').forEach(option => {
    option.addEventListener('click', function() {
      const value = this.getAttribute('data-value');
      const inputName = this.getAttribute('data-input');
      const hiddenInput = document.querySelector(`input[name="${inputName}"]`);
      if (hiddenInput) hiddenInput.value = value;

      const parentRow = this.closest('.option-row');
      parentRow.querySelectorAll('.option-box').forEach(opt => opt.classList.remove('active'));
      this.classList.add('active');

      const errorMessage = this.closest('.question-group').querySelector('.error-message');
      if (errorMessage) {
        errorMessage.style.display = 'none';
      }
    });
  });

  document.querySelectorAll('input[type="number"]').forEach(input => {
    input.addEventListener('input', function() {
      const errorMessage = this.closest('.question-group').querySelector('.error-message');
      if (errorMessage) {
        errorMessage.style.display = 'none';
      }
    });
  });

  surveyForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!validateQuestion(currentQuestionIndex)) {
      return;
    }
    
    const formData = new FormData(this);
    const data = {};
    let hasEmptyFields = false;
    
    formData.forEach((value, key) => {
      data[key] = value;
      if (!value) {
        hasEmptyFields = true;
      }
    });

    if (hasEmptyFields) {
      alert('모든 질문에 답변해주세요.');
      return;
    }

    const submitButton = this.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;
    submitButton.textContent = '제출 중...';
    submitButton.disabled = true;

    fetch('{% url "mypage:save_survey" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        alert(data.message);
        window.location.href = '{% url "mypage:survey_result" %}';
      } else {
        alert('오류가 발생했습니다: ' + data.message);
        submitButton.textContent = originalText;
        submitButton.disabled = false;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('오류가 발생했습니다. 다시 시도해주세요.');
      submitButton.textContent = originalText;
      submitButton.disabled = false;
    });
  });
});
</script>
{% endblock %}

