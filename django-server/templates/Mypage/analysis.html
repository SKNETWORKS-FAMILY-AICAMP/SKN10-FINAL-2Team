{% extends 'Mypage/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/Mypage/header.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/Mypage/analysis.css' %}">
{% endblock %}

{% block content %}
<div id="favoriteModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>좋아요한 영양제</h2>
        <div id="favorite-products" class="favorite-products-grid"></div>
    </div>
</div>

<div class="my_healthy">
    <div class="card-row-flex">
        <!-- Lewa karta -->
        <div class="card-box left-card">
            <div class="title">영양제 추가하기</div>
            <input type="file" id="ocr-upload" accept="image/*" style="display:none" onchange="handleOcrUpload(event)">
            <div class="upload-box" onclick="document.getElementById('ocr-upload').click()">
                <span>이미지 업로드하기</span>
            </div>
            <div class="upload-box" onclick="loadFavoriteProducts()">
                <span>좋아요한 영양제 불러오기</span>
            </div>
            <div class="upload-box" onclick="showManualInput()">
                <span>직접 입력하기</span>
            </div>
            <div id="product-details" class="product-details">
                <!-- Tutaj pojawią się szczegóły wybranego produktu -->
            </div>
            <div id="ocr-error" style="color:red; margin-top:10px;"></div>
        </div>

        <!-- Prawa karta -->
        <div class="card-box right-card">
            <div class="title">{{ user.username }}님의 영양분석</div>
            <div class="product-image-line"></div>
            <div class="product-image-box">
                <img src="{% static 'images/product1.jpg' %}" alt="제품 이미지" class="product-image">
            </div>
            <div class="product-image-line"></div>
            <div class="result-content">
                <h2>권장섭취량 대비 섭취량 분석</h2>
                <div id="nutrientAnalysis">
                    <!-- 여기에 영양소 분석 결과가 동적으로 표시됩니다 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 이미지 업로드 모달 -->
<div id="imageUploadModal" class="modal">
    <div class="modal-content">
        <h2>이미지 업로드</h2>
        <input type="file" id="imageInput" accept="image/*">
        <button onclick="uploadImage()">업로드</button>
        <button onclick="closeModal('imageUploadModal')">취소</button>
    </div>
</div>

<!-- 직접 입력 모달 -->
<div id="manualInputModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('manualInputModal')">&times;</span>
        <h2>영양소 직접입력</h2>
        <div class="input-group">
            <label for="nutrientNameInput">영양소 이름:</label>
            <input type="text" id="nutrientNameInput" placeholder="예: 비타민C">
        </div>
        <div class="input-group">
            <label for="unitInput">단위:</label>
            <input type="text" id="unitInput" placeholder="예: mg">
        </div>
        <div class="input-group">
            <label for="amountInput">섭취량:</label>
            <input type="number" id="amountInput" placeholder="예: 100">
        </div>
        <button onclick="saveManualInput()" class="btn-primary">저장</button>
    </div>
</div>

<!-- 수정 모달 -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('editModal')">&times;</span>
        <h2>영양소 섭취 기록 수정</h2>
        <input type="hidden" id="editIntakeId">
        <div class="input-group">
            <label for="editAmountInput">섭취량:</label>
            <input type="number" id="editAmountInput">
        </div>
        <div class="input-group">
            <label for="editDateInput">날짜:</label>
            <input type="date" id="editDateInput">
        </div>
        <button onclick="updateNutrientIntake()" class="btn-primary">수정</button>
    </div>
</div>

<script>
function navigateTo(page) {
    switch(page) {
        case 'mypage':
            window.location.href = "{% url 'mypage:mypage' %}";
            break;
        case 'survey':
            window.location.href = "{% url 'mypage:survey' %}";
            break;
        case 'favorite':
            window.location.href = "{% url 'mypage:like_list' %}";
            break;
        case 'analysis':
            window.location.href = "{% url 'mypage:analysis' %}";
            break;
    }
}

// CSRF 토큰 가져오기
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 이미지 업로드 처리
function handleOcrUpload(event) {
    const file = event.target.files[0];
    console.log('Plik wybrany:', file);
    if (!file) return;
    const formData = new FormData();
    formData.append('image', file);
    document.getElementById('ocr-error').innerText = '';
    fetch('/mypage/ocr_extract/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => {
        console.log('OCR response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Odpowiedź OCR:', data);
        if (data.status === 'success') {
            showProductDetails({ingredients: data.ingredients});
        } else if (data.status === 'debug') {
            document.getElementById('ocr-error').innerText = 'OCR raw text: ' + (data.raw_text || 'brak');
        } else {
            document.getElementById('ocr-error').innerText = data.message || '성분 인식에 실패했습니다.';
        }
    })
    .catch((err) => {
        document.getElementById('ocr-error').innerText = '서버 오류가 발생했습니다.';
        console.error('OCR fetch error:', err);
    });
}

// Dodaj zmienne dla modalu
const modal = document.getElementById("favoriteModal");
const span = document.getElementsByClassName("close")[0];

// Zamknij modal po kliknięciu X
span.onclick = function() {
    modal.style.display = "none";
}

// Zamknij modal po kliknięciu poza nim
window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

function loadFavoriteProducts() {
    fetch('/mypage/like/')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const favoritesList = document.querySelector('.favorites-list');
                favoritesList.innerHTML = '';
                
                data.products.forEach(product => {
                    const favoriteItem = document.createElement('div');
                    favoriteItem.className = 'favorite-item';
                    favoriteItem.innerHTML = `
                        <img src="${product.image_link}" alt="${product.title}" class="favorite-image">
                        <div class="favorite-info">
                            <h3>${product.title}</h3>
                            <p>${product.ingredients}</p>
                        </div>
                        <button class="remove-favorite" onclick="removeFavorite(${product.id})">삭제</button>
                    `;
                    favoritesList.appendChild(favoriteItem);
                });
                
                // Pokaż modal
                modal.style.display = "block";
            } else {
                console.error('Error loading favorites:', data.message);
                alert('좋아요한 영양제를 불러오는데 실패했습니다.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('좋아요한 영양제를 불러오는데 실패했습니다.');
        });
}

function removeFavorite(productId) {
    fetch('/mypage/like-delete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            product_id: productId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            loadFavoriteProducts();
        } else {
            console.error('Error removing favorite:', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('영양제 삭제에 실패했습니다.');
    });
}

// 직접 입력 모달
function showManualInput() {
    const modal = document.getElementById('manualInputModal');
    modal.style.display = "block";
}

function updateNutrientAnalysis() {
    console.log('영양분석 데이터 가져오기 시작');
    fetch('/mypage/get-nutrient-data/')
        .then(response => response.json())
        .then(data => {
            console.log('받은 데이터:', data);
            if (data.status === 'success') {
                const analysisDiv = document.getElementById('nutrientAnalysis');
                console.log('total_nutrients:', data.data.total_nutrients);
                const nutrients = JSON.parse(data.data.total_nutrients);
                console.log('파싱된 영양소 데이터:', nutrients);
                
                let html = '';
                for (const [nutrientName, nutrientData] of Object.entries(nutrients)) {
                    const avgIntake = nutrientData.total / nutrientData.count;
                    const percentage = (avgIntake / nutrientData.recommended) * 100;
                    console.log(`${nutrientName}: 평균 섭취량=${avgIntake}, 권장량=${nutrientData.recommended}, 비율=${percentage}%`);
                    
                    html += `
                        <div class="nutrition-item">
                            <span class="nutrition-label">${nutrientName}</span>
                            <div class="nutrition-bar">
                                <div class="nutrition-bar-fill" style="width: ${Math.min(100, percentage)}%"></div>
                            </div>
                            <span class="nutrition-percent">${percentage.toFixed(1)}%</span>
                        </div>
                    `;
                }
                
                analysisDiv.innerHTML = html;
            } else {
                console.error('영양분석 데이터 가져오기 실패:', data.message);
                document.getElementById('nutrientAnalysis').innerHTML = '<p>영양분석 데이터를 불러올 수 없습니다.</p>';
            }
        })
        .catch(error => {
            console.error('영양분석 데이터 가져오기 오류:', error);
            document.getElementById('nutrientAnalysis').innerHTML = '<p>영양분석 데이터를 불러오는 중 오류가 발생했습니다.</p>';
        });
}

// 페이지 로드 시 영양분석 데이터와 기록 가져오기
document.addEventListener('DOMContentLoaded', function() {
    updateNutrientAnalysis();
    loadNutrientHistory();
});

// 영양소 섭취 기록 가져오기
function loadNutrientHistory() {
    fetch('/mypage/get-nutrient-history/')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const historyDiv = document.getElementById('nutrientHistory');
                let html = '<table class="history-table">';
                html += `
                    <thead>
                        <tr>
                            <th>날짜</th>
                            <th>영양소</th>
                            <th>섭취량</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                
                data.data.forEach(item => {
                    html += `
                        <tr>
                            <td>${item.date}</td>
                            <td>${item.nutrient_name}</td>
                            <td>${item.amount} ${item.unit}</td>
                            <td>
                                <button onclick="openEditModal(${item.id}, ${item.amount}, '${item.date}')" class="btn-edit">수정</button>
                                <button onclick="deleteNutrientIntake(${item.id})" class="btn-delete">삭제</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                historyDiv.innerHTML = html;
            } else {
                document.getElementById('nutrientHistory').innerHTML = '<p>영양소 섭취 기록을 불러올 수 없습니다.</p>';
            }
        })
        .catch(error => {
            console.error('영양소 기록 가져오기 오류:', error);
            document.getElementById('nutrientHistory').innerHTML = '<p>영양소 섭취 기록을 불러오는 중 오류가 발생했습니다.</p>';
        });
}

// 직접입력 저장
function saveManualInput() {
    const nutrientName = document.getElementById('nutrientNameInput').value;
    const unit = document.getElementById('unitInput').value;
    const amount = document.getElementById('amountInput').value;
    
    if (nutrientName && unit && amount) {
        fetch('/mypage/add-manual-nutrient/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                nutrient_name: nutrientName,
                unit: unit,
                amount: parseFloat(amount)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('영양소 섭취 기록이 추가되었습니다.');
                closeModal('manualInputModal');
                // 입력 필드 초기화
                document.getElementById('nutrientNameInput').value = '';
                document.getElementById('unitInput').value = '';
                document.getElementById('amountInput').value = '';
                // 영양분석과 기록 업데이트
                updateNutrientAnalysis();
                loadNutrientHistory();
            } else {
                alert('오류가 발생했습니다: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('영양소 섭취 기록 추가에 실패했습니다.');
        });
    } else {
        alert('모든 값을 입력해주세요.');
    }
}

// 수정 모달 열기
function openEditModal(id, amount, date) {
    document.getElementById('editIntakeId').value = id;
    document.getElementById('editAmountInput').value = amount;
    document.getElementById('editDateInput').value = date;
    openModal('editModal');
}

// 영양소 섭취 기록 수정
function updateNutrientIntake() {
    const id = document.getElementById('editIntakeId').value;
    const amount = document.getElementById('editAmountInput').value;
    const date = document.getElementById('editDateInput').value;
    
    if (amount && date) {
        fetch('/mypage/update-nutrient-intake/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                id: id,
                amount: parseFloat(amount),
                date: date
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('영양소 섭취 기록이 수정되었습니다.');
                closeModal('editModal');
                // 영양분석과 기록 업데이트
                updateNutrientAnalysis();
                loadNutrientHistory();
            } else {
                alert('오류가 발생했습니다: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('영양소 섭취 기록 수정에 실패했습니다.');
        });
    } else {
        alert('모든 값을 입력해주세요.');
    }
}

// 영양소 섭취 기록 삭제
function deleteNutrientIntake(id) {
    if (confirm('정말로 이 기록을 삭제하시겠습니까?')) {
        fetch('/mypage/delete-nutrient-intake/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                id: id
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('영양소 섭취 기록이 삭제되었습니다.');
                // 영양분석과 기록 업데이트
                updateNutrientAnalysis();
                loadNutrientHistory();
            } else {
                alert('오류가 발생했습니다: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('영양소 섭취 기록 삭제에 실패했습니다.');
        });
    }
}

// 모달 열기
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.style.display = "block";
}

// 모달 닫기
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.style.display = "none";
}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Pobierz dane o składnikach odżywczych
    fetch('/mypage/get_nutrient_data/')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Przygotuj dane do wykresu
                const labels = Object.keys(data.nutrients);
                const actualValues = labels.map(nutrient => data.nutrients[nutrient].actual_amount);
                const recommendedValues = labels.map(nutrient => data.nutrients[nutrient].recommended_amount);

                // Stwórz wykres
                const ctx = document.getElementById('nutrientChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '실제 섭취량',
                                data: actualValues,
                                backgroundColor: 'rgba(76, 175, 80, 0.5)',
                                borderColor: 'rgba(76, 175, 80, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '권장 섭취량',
                                data: recommendedValues,
                                backgroundColor: 'rgba(33, 150, 243, 0.5)',
                                borderColor: 'rgba(33, 150, 243, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
});

function showProductDetails(product) {
    const detailsDiv = document.getElementById('product-details');
    if (!product) {
        detailsDiv.innerHTML = '';
        return;
    }
    let html = '<h3>제품 성분</h3><ul>';
    for (const [key, value] of Object.entries(product.ingredients)) {
        html += `<li><strong>${key}</strong>: ${value}</li>`;
    }
    html += '</ul>';
    detailsDiv.innerHTML = html;
}
</script>
{% endblock %} 