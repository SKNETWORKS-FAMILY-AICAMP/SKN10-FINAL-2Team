{% extends 'Mypage/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/Mypage/header.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/Mypage/analysis.css' %}">
<style>
/* GÅ‚Ã³wny kontener - stabilny layout */
.analysis-container {
    width: 468px;
    height: 780px;
    margin: 120px auto 60px auto;
    border-radius: 6px;
    background: #fff;
    box-sizing: border-box;
    padding: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    box-shadow: 0px 0px 8px rgba(0, 0, 0, 0.25);
    border: none;
    position: relative;
    overflow: hidden; /* Zapobiega przepeÅ‚nieniu */
}

/* Kontener z kartami - staÅ‚a wysokoÅ›Ä‡ */
.main-cards {
    width: 100%;
    height: 100%;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    scrollbar-width: none;
    padding: 10px 0;
    position: relative;
}

/* Ukryj scrollbar dla WebKit */
.main-cards::-webkit-scrollbar {
    display: none;
}

/* Karty z lepszym pozycjonowaniem */
.card {
    width: 438px;
    background: white;
    border-radius: 6px;
    padding: 16px;
    box-shadow: 0 0 3px 0 rgba(0,0,0,0.25);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    cursor: pointer;
    border: 2px solid transparent;
    display: flex;
    align-items: center;
    gap: 16px;
    margin-top: 8px;
    margin-bottom: 8px;
    box-sizing: border-box;
    position: relative;
    flex-shrink: 0; /* Zapobiega Å›ciskaniu kart */
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 8px 0 rgba(0,0,0,0.25);
}

.card.upload-card {
    border-color: #DDC66F;
}

.card.favorite-card {
    border-color: #EADCA6;
}

.card.manual-card {
    border-color: #C4A94C;
}

.card.analysis-card {
    border-color: #DDC66F;
}

.card-icon {
    font-size: 2.5em;
    flex-shrink: 0;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.card-content {
    flex: 1;
    min-width: 0;
}

.card-title {
    font-size: 1.2em;
    font-weight: bold;
    margin-bottom: 8px;
    color: #333;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.card-description {
    color: #666;
    font-size: 0.9em;
    line-height: 1.4;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

/* Wyniki analizy - peÅ‚na wysokoÅ›Ä‡ kontenera */
.analysis-results {
    display: none;
    width: 100%;
    height: 100%;
    overflow-y: auto;
    padding: 20px;
    position: absolute;
    top: 0;
    left: 0;
    background: #fff;
    z-index: 10;
}

.analysis-header {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
    width: 100%;
}

.back-button {
    background: #DDC66F;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 700;
    transition: background-color 0.2s;
    margin-bottom: 20px;
    align-self: flex-start;
}

.back-button:hover {
    background: #C4A94C;
}

.analysis-title {
    font-size: 1.5em;
    font-weight: bold;
    color: #333;
}

.nutrient-grid {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 20px;
}

.nutrient-item {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 16px;
    border-left: 4px solid #DDC66F;
}

.nutrient-label {
    font-weight: bold;
    color: #333;
    margin-bottom: 8px;
    display: block;
}

.nutrition-bar {
    background: #e9ecef;
    border-radius: 8px;
    height: 16px;
    margin: 8px 0;
    overflow: hidden;
}

.nutrition-bar-fill {
    background: linear-gradient(90deg, #DDC66F, #C4A94C);
    height: 100%;
    border-radius: 8px;
    transition: width 0.3s ease;
}

.nutrition-percent {
    font-weight: bold;
    color: #DDC66F;
    float: right;
}

.history-section {
    margin-top: 20px;
}

.history-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
    font-size: 14px;
}

.history-table th,
.history-table td {
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.history-table th {
    background: #f8f9fa;
    font-weight: bold;
    color: #333;
}

.btn-edit, .btn-delete {
    padding: 4px 8px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-right: 4px;
    font-size: 12px;
}

.btn-edit {
    background: #EADCA6;
    color: #333;
}

.btn-delete {
    background: #C4A94C;
    color: white;
}

.btn-edit:hover {
    background: #DDC66F;
}

.btn-delete:hover {
    background: #B39B3A;
}

/* Modal styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    border-radius: 8px;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-group select,
.form-group input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.btn-save {
    background: #DDC66F;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-save:hover {
    background: #C4A94C;
}

/* Dodatkowe style dla lepszej stabilnoÅ›ci */
* {
    box-sizing: border-box;
}

body {
    overflow-x: hidden;
}

/* ResponsywnoÅ›Ä‡ */
@media (max-width: 768px) {
    .analysis-container {
        width: 95%;
        margin: 100px auto 40px auto;
    }
    
    .card {
        width: 100%;
        max-width: 400px;
    }
}
</style>
{% endblock %}

{% block mypage_content %}
{% if error_message %}
<div style="background: #ffebee; color: #d32f2f; padding: 15px; margin: 20px; border-radius: 5px; border: 1px solid #f44336;">
    <strong>âš ï¸ ì˜¤ë¥˜ ë°œìƒ</strong><br>
    {{ error_message }}
</div>
{% endif %}

<div class="analysis-container">
    <!-- GÅ‚Ã³wne karty -->
    <div class="main-cards" id="mainCards">
        <!-- Karta upload obrazu -->
        <div class="card upload-card" onclick="handleCardClick('upload')">
            <div class="card-icon">ğŸ“·</div>
            <div class="card-content">
                <div class="card-title">ì œí’ˆ ë¼ë²¨ ì—…ë¡œë“œí•˜ê¸°</div>
                <div class="card-description">
                    ì˜ì–‘ì œ ë¼ë²¨ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì—¬ ìë™ìœ¼ë¡œ ì„±ë¶„ì„ ì¸ì‹í•˜ê³  ë¶„ì„í•©ë‹ˆë‹¤
                </div>
            </div>
        </div>

        <!-- Karta ulubionych produktÃ³w -->
        <div class="card favorite-card" onclick="handleCardClick('favorite')">
            <div class="card-icon">â¤ï¸</div>
            <div class="card-content">
                <div class="card-title">ì¢‹ì•„ìš”í•œ ì˜ì–‘ì œ ë¶ˆëŸ¬ì˜¤ê¸°</div>
                <div class="card-description">
                    ì´ì „ì— ì¢‹ì•„ìš”í•œ ì˜ì–‘ì œë“¤ì„ ë¹ ë¥´ê²Œ ë¶ˆëŸ¬ì™€ì„œ ë¶„ì„ì— ì¶”ê°€í•©ë‹ˆë‹¤
                </div>
            </div>
        </div>

        <!-- Karta rÄ™cznego wprowadzania -->
        <div class="card manual-card" onclick="handleCardClick('manual')">
            <div class="card-icon">âœï¸</div>
            <div class="card-content">
                <div class="card-title">ì§ì ‘ ì…ë ¥í•˜ê¸°</div>
                <div class="card-description">
                    ì˜ì–‘ì†Œë¥¼ ì§ì ‘ ì…ë ¥í•˜ì—¬ ì„­ì·¨ëŸ‰ì„ ê¸°ë¡í•˜ê³  ë¶„ì„í•©ë‹ˆë‹¤
                </div>
            </div>
        </div>

        <!-- Karta analizy -->
        <div class="card analysis-card" onclick="handleCardClick('analysis')">
            <div class="card-icon">ğŸ“Š</div>
            <div class="card-content">
                <div class="card-title">ì˜ì–‘ë¶„ì„ ê²°ê³¼ë³´ê¸°</div>
                <div class="card-description">
                    í˜„ì¬ê¹Œì§€ì˜ ì˜ì–‘ì†Œ ì„­ì·¨ëŸ‰ì„ ë¶„ì„í•˜ê³  ê¶Œì¥ì‚¬í•­ì„ í™•ì¸í•©ë‹ˆë‹¤
                </div>
            </div>
        </div>
    </div>

    <!-- Ukryte inputy -->
    <input type="file" id="ocr-upload" accept="image/*" style="display:none" onchange="handleOcrUpload(event)">

    <!-- OCR ê²°ê³¼ í‘œì‹œ ì˜ì—­ (í•­ìƒ ì ‘ê·¼ ê°€ëŠ¥) -->
    <div id="ocr-error" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); z-index: 1000; max-width: 80%; max-height: 80%; overflow-y: auto;">
        <!-- OCR ì˜¤ë¥˜ ë° ê²°ê³¼ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
    </div>

    <!-- Sekcja wynikÃ³w analizy (poczÄ…tkowo ukryta) -->
    <div id="analysis-results" class="analysis-results">
        <button class="back-button" onclick="showMainCards()">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        <div class="analysis-header">
            <h1 class="analysis-title">{{ user.username }}ë‹˜ì˜ ì˜ì–‘ë¶„ì„</h1>
        </div>
        
        <div class="nutrient-grid">
            <div id="nutrientAnalysis">
                <!-- ì—¬ê¸°ì— ì˜ì–‘ì†Œ ë¶„ì„ ê²°ê³¼ê°€ ë™ì ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <div class="history-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2>ì˜ì–‘ì†Œ ì„­ì·¨ ê¸°ë¡</h2>
                <button onclick="deleteAllNutrientRecords()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">ì „ì²´ ì‚­ì œ</button>
            </div>
            <div id="nutrientHistory">
                <!-- ì—¬ê¸°ì— ì˜ì–‘ì†Œ ì„­ì·¨ ê¸°ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>
</div>

<!-- Modale -->
<div id="manualInputModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('manualInputModal')">&times;</span>
        <h2>ì˜ì–‘ì†Œ ì§ì ‘ì…ë ¥</h2>
        <div class="input-group" style="position:relative;">
            <label for="nutrientNameInput">ì˜ì–‘ì†Œ ì´ë¦„:</label>
            <input type="text" id="nutrientNameInput" placeholder="ì˜ˆ: ë¹„íƒ€ë¯¼C" autocomplete="off">
            <ul id="autocomplete-list" style="border:1px solid #ccc; display:none; position:absolute; background:white; z-index:1000; width:90%; list-style:none; margin:0; padding:0;"></ul>
        </div>
        <div class="input-group">
            <label for="unitInput">ë‹¨ìœ„:</label>
            <input type="text" id="unitInput" placeholder="ì˜ˆ: mg">
        </div>
        <div class="input-group">
            <label for="amountInput">ì„­ì·¨ëŸ‰:</label>
            <input type="number" id="amountInput" placeholder="ì˜ˆ: 100">
        </div>
        <button class="btn-primary" onclick="submitManualInput()">ì €ì¥</button>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>ì˜ì–‘ì†Œ ì„­ì·¨ ìˆ˜ì •</h2>
        <form id="editForm">
            <input type="hidden" id="intakeId">
            <div class="form-group">
                <label for="editNutrient">ì˜ì–‘ì†Œ</label>
                <select id="editNutrient" required>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            <div class="form-group">
                <label for="editAmountInput">ì…ë ¥ìˆ˜ëŸ‰</label>
                <input type="number" id="editAmountInput" step="0.01" required>
            </div>
            <div class="form-group">
                <label for="editUnitInput">ë‹¨ìœ„</label>
                <input type="text" id="editUnitInput" required>
            </div>
            <button type="submit" class="btn-save">ì €ì¥</button>
        </form>
    </div>
</div>

<!-- ì¢‹ì•„ìš”í•œ ì œí’ˆ ì„ íƒ ëª¨ë‹¬ -->
<div id="productSelectionModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
        <div class="modal-header">
            <h3>ì¢‹ì•„ìš”í•œ ì œí’ˆ ì„ íƒ</h3>
            <span class="close" onclick="closeModal('productSelectionModal')">&times;</span>
        </div>
        <div class="modal-body">
            <p>ì˜ì–‘ì„±ë¶„ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ì œí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”:</p>
            <div id="likedProductsList" style="margin: 20px 0;">
                <!-- ì œí’ˆ ëª©ë¡ì´ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button onclick="selectAllProducts()" style="padding: 8px 16px; border: none; background: #DDC66F; color: white; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500;">ì „ì²´ ì„ íƒ</button>
                <button onclick="deselectAllProducts()" style="padding: 8px 16px; border: none; background: #DDC66F; color: white; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500;">ì „ì²´ í•´ì œ</button>
                <button onclick="loadSelectedProducts()" style="padding: 8px 16px; background: #DDC66F; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500;">ì„ íƒí•œ ì œí’ˆ ì˜ì–‘ì„±ë¶„ ê°€ì ¸ì˜¤ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script>
// í˜ì´ì§€ ë¡œë“œ ì‹œ ë””ë²„ê¹…
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, checking elements...');
    
    // íŒŒì¼ input ìš”ì†Œ í™•ì¸
    const fileInput = document.getElementById('ocr-upload');
    if (fileInput) {
        console.log('File input found:', fileInput);
        console.log('File input attributes:', {
            id: fileInput.id,
            type: fileInput.type,
            accept: fileInput.accept,
            style: fileInput.style.display
        });
    } else {
        console.error('File input not found on page load!');
    }
    
    // ì¹´ë“œ ìš”ì†Œë“¤ í™•ì¸
    const uploadCard = document.querySelector('.upload-card');
    if (uploadCard) {
        console.log('Upload card found:', uploadCard);
        console.log('Upload card onclick:', uploadCard.onclick);
    } else {
        console.error('Upload card not found!');
    }
});

// ObsÅ‚uga klikniÄ™Ä‡ w karty
function handleCardClick(cardType) {
    console.log('Card clicked:', cardType); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
    
    switch(cardType) {
        case 'upload':
            console.log('Upload card clicked, triggering file input...'); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
            const fileInput = document.getElementById('ocr-upload');
            if (fileInput) {
                console.log('File input found, clicking...'); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
                fileInput.click();
            } else {
                console.error('File input not found!'); // ì˜¤ë¥˜ ë¡œê·¸ ì¶”ê°€
                alert('íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            break;
        case 'favorite':
            // ì¢‹ì•„ìš”í•œ ì œí’ˆ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
            showProductSelectionModal();
            break;
        case 'manual':
            showManualInput();
            break;
        case 'analysis':
            showAnalysisResults();
            break;
    }
}

// PokaÅ¼ gÅ‚Ã³wne karty
function showMainCards() {
    document.querySelector('.main-cards').style.display = 'flex';
    document.getElementById('analysis-results').style.display = 'none';
}

// PokaÅ¼ wyniki analizy
function showAnalysisResults() {
    document.querySelector('.main-cards').style.display = 'none';
    document.getElementById('analysis-results').style.display = 'block';
    
    // ìë™ìœ¼ë¡œ ì˜ì–‘ë¶„ì„ ì‹¤í–‰
    runNutrientAnalysis();
    loadNutrientHistory();
    
    // ì¢‹ì•„ìš”í•œ ì œí’ˆì€ ì‚¬ìš©ìê°€ ì§ì ‘ í´ë¦­í•  ë•Œë§Œ ë¡œë“œ
}

function navigateTo(page) {
    switch(page) {
        case 'mypage':
            window.location.href = "{% url 'mypage:mypage' %}";
            break;
        case 'survey':
            window.location.href = "{% url 'mypage:survey' %}";
            break;
        case 'favorite':
            window.location.href = "{% url 'mypage:like_list' %}";
            break;
        case 'analysis':
            window.location.href = "{% url 'mypage:analysis' %}";
            break;
    }
}

// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
function handleOcrUpload(event) {
    console.log('handleOcrUpload called'); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
    console.log('Event:', event); // ì´ë²¤íŠ¸ ê°ì²´ ë¡œê·¸
    
    const file = event.target.files[0];
    console.log('Plik wybrany:', file);
    
    if (!file) {
        console.log('No file selected'); // íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° ë¡œê·¸
        return;
    }
    
    console.log('File details:', {
        name: file.name,
        size: file.size,
        type: file.type
    }); // íŒŒì¼ ìƒì„¸ ì •ë³´ ë¡œê·¸
    
    // PokaÅ¼ wyniki analizy
    showAnalysisResults();
    
    const formData = new FormData();
    formData.append('image', file);
    
    // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
    const errorDiv = document.getElementById('ocr-error');
    if (!errorDiv) {
        console.error('Element ocr-error not found');
        alert('ì˜¤ë¥˜: OCR ê²°ê³¼ë¥¼ í‘œì‹œí•  ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    console.log('Starting OCR request...'); // OCR ìš”ì²­ ì‹œì‘ ë¡œê·¸
    
    errorDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading-spinner"></div><p>ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p></div>';
    errorDiv.style.display = 'block';
    
    fetch('/mypage/ocr_extract/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => {
        console.log('OCR response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('OdpowiedÅº OCR:', data);
        
        if (data.status === 'success') {
            const ingredients = data.ingredients;
            
            // Messageê°€ ìˆëŠ” ê²½ìš° (ì˜ì–‘ì†Œ ì¶”ì¶œ ì‹¤íŒ¨)
            if (ingredients.Message) {
                // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ì§€ ì•Šê³  ì¡°ìš©íˆ ì²˜ë¦¬
                errorDiv.style.display = 'none';
                return;
            } else {
                // ì„±ê³µì ìœ¼ë¡œ ì˜ì–‘ì†Œ ì¶”ì¶œëœ ê²½ìš°
                console.log('Extracted ingredients:', ingredients);
                
                // OCR ê²°ê³¼ë¥¼ ìë™ìœ¼ë¡œ ì˜ì–‘ë¶„ì„ì— ì €ì¥
                saveOcrIngredientsToAnalysis(ingredients);
                
                showProductDetails({
                    ingredients: ingredients,
                    compatibility: data.compatibility
                });
                errorDiv.style.display = 'none';
                
                // ì„±ê³µ ë©”ì‹œì§€ë¥¼ alertë¡œ í‘œì‹œ (í•œ ë²ˆë§Œ)
                alert('âœ… ì˜ì–‘ì†Œ ì¶”ì¶œ ì„±ê³µ!\n' + 
                      (ingredients.debug_info ? `${ingredients.debug_info.extracted_count}ê°œì˜ ì˜ì–‘ì†Œê°€ ì¸ì‹ë˜ì—ˆìŠµë‹ˆë‹¤.` : 'ì˜ì–‘ì†Œ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ì¶œë˜ì—ˆìŠµë‹ˆë‹¤.'));
                
                // ìë™ìœ¼ë¡œ ì˜ì–‘ë¶„ì„ í™”ë©´ìœ¼ë¡œ ì´ë™
                showAnalysisResults();
            }
        } else if (data.status === 'debug') {
            // ë””ë²„ê·¸ ëª¨ë“œë„ ì¡°ìš©íˆ ì²˜ë¦¬
            errorDiv.style.display = 'none';
            // ìë™ìœ¼ë¡œ ì˜ì–‘ë¶„ì„ í™”ë©´ìœ¼ë¡œ ì´ë™
            showAnalysisResults();
        } else {
            // OCR ì„±ê³µí–ˆì§€ë§Œ ì˜ì–‘ì†Œ ì¶”ì¶œ ì‹¤íŒ¨í•œ ê²½ìš°ë„ ì¡°ìš©íˆ ì²˜ë¦¬
            errorDiv.style.display = 'none';
            // ìë™ìœ¼ë¡œ ì˜ì–‘ë¶„ì„ í™”ë©´ìœ¼ë¡œ ì´ë™
            showAnalysisResults();
        }
    })
    .catch((err) => {
        console.error('OCR fetch error:', err);
        // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ì§€ ì•Šê³  ì¡°ìš©íˆ ì²˜ë¦¬
        // errorDivê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ ìˆ¨ê¹€
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }
    });
}

function loadFavoriteProducts() {
    // ì¢‹ì•„ìš”í•œ ì œí’ˆ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
    showProductSelectionModal();
}

function showProductSelectionModal() {
    const modal = document.getElementById('productSelectionModal');
    modal.style.display = 'block';
    
    // ì¢‹ì•„ìš”í•œ ì œí’ˆ ëª©ë¡ ë¡œë“œ
    loadLikedProductsList();
}

function loadLikedProductsList() {
    const productsListDiv = document.getElementById('likedProductsList');
    productsListDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading-spinner"></div><p>ì¢‹ì•„ìš”í•œ ì œí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';
    
    // Django contextì—ì„œ ì „ë‹¬ëœ liked_supplements ë°ì´í„° ì‚¬ìš©
    const likedSupplements = JSON.parse('{{ liked_supplements|escapejs }}');
    
    if (likedSupplements && likedSupplements.length > 0) {
        let html = '';
        likedSupplements.forEach(product => {
            html += `
                <div style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" value="${product.id}" style="margin-right: 10px;" onchange="updateSelectedCount()">
                        <div>
                            <strong>${product.title}</strong><br>
                            <small style="color: #666;">${product.brand || product.manufacturer || 'ì„¤ëª… ì—†ìŒ'}</small>
                        </div>
                    </label>
                </div>
            `;
        });
        productsListDiv.innerHTML = html;
        updateSelectedCount();
    } else {
        // ì¢‹ì•„ìš”í•œ ì œí’ˆì´ ì—†ëŠ” ê²½ìš° APIë¡œ ì¬ì‹œë„
        fetch('/mypage/get-favorite-products/')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.data.length > 0) {
                    let html = '';
                    data.data.forEach(product => {
                        html += `
                            <div style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" value="${product.id}" style="margin-right: 10px;" onchange="updateSelectedCount()">
                                    <div>
                                        <strong>${product.title}</strong><br>
                                        <small style="color: #666;">${product.brand || product.manufacturer || 'ì„¤ëª… ì—†ìŒ'}</small>
                                    </div>
                                </label>
                            </div>
                        `;
                    });
                    productsListDiv.innerHTML = html;
                    updateSelectedCount();
                } else {
                    productsListDiv.innerHTML = '<p style="text-align: center; color: #666;">ì¢‹ì•„ìš”í•œ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                productsListDiv.innerHTML = '<p style="text-align: center; color: #d32f2f;">ì œí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            });
    }
}

function selectAllProducts() {
    const checkboxes = document.querySelectorAll('#likedProductsList input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    updateSelectedCount();
}

function deselectAllProducts() {
    const checkboxes = document.querySelectorAll('#likedProductsList input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updateSelectedCount();
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('#likedProductsList input[type="checkbox"]:checked');
    const count = checkboxes.length;
    console.log(`ì„ íƒëœ ì œí’ˆ ìˆ˜: ${count}`);
}

function loadSelectedProducts() {
    const checkboxes = document.querySelectorAll('#likedProductsList input[type="checkbox"]:checked');
    const selectedProductIds = Array.from(checkboxes).map(checkbox => checkbox.value);
    
    if (selectedProductIds.length === 0) {
        alert('ì„ íƒëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ëª¨ë‹¬ ë‹«ê¸°
    closeModal('productSelectionModal');
    
    // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
    const historyDiv = document.getElementById('nutrientHistory');
    historyDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading-spinner"></div><p>ì„ íƒí•œ ì œí’ˆì˜ ì˜ì–‘ì„±ë¶„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';
    
    fetch('/mypage/load-selected-products-nutrients/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            product_ids: selectedProductIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // ì„±ê³µ ë©”ì‹œì§€ë¥¼ alertë¡œ í‘œì‹œ (í•œ ë²ˆë§Œ)
            alert('âœ… ì˜ì–‘ì„±ë¶„ ì •ë³´ ë¡œë“œ ì™„ë£Œ!\n' + data.message + '\nì¶”ê°€ëœ ì˜ì–‘ì„±ë¶„: ' + data.added_count + 'ê°œ');
            
            // ì˜ì–‘ë¶„ì„ê³¼ ê¸°ë¡ ì—…ë°ì´íŠ¸
            updateNutrientAnalysis();
            loadNutrientHistory();
            
            // ìë™ìœ¼ë¡œ ì˜ì–‘ë¶„ì„ í™”ë©´ìœ¼ë¡œ ì´ë™
            showAnalysisResults();
        } else {
            historyDiv.innerHTML = `<div style="color: #d32f2f; padding: 15px; background: #ffebee; border-radius: 5px; margin: 10px 0;">
                <strong>âŒ ì˜¤ë¥˜ ë°œìƒ</strong><br>
                ${data.message}
            </div>`;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        historyDiv.innerHTML = `<div style="color: #d32f2f; padding: 15px; background: #ffebee; border-radius: 5px; margin: 10px 0;">
            <strong>âŒ ì„œë²„ ì˜¤ë¥˜</strong><br>
            ì„ íƒí•œ ì œí’ˆì˜ ì˜ì–‘ì„±ë¶„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
        </div>`;
    });
}

function addToAnalysis(productId) {
    fetch(`/mypage/product/${productId}/nutrients/`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Product nutrients:', data.nutrients);
                // TODO: Implement adding nutrients to analysis
            } else {
                alert('ì œí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì œí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });
}

// ì§ì ‘ ì…ë ¥ ëª¨ë‹¬
function showManualInput() {
    const modal = document.getElementById('manualInputModal');
    modal.style.display = "block";
}

// ì˜ì–‘ë¶„ì„ ì‹¤í–‰
function runNutrientAnalysis() {
    console.log('ì˜ì–‘ë¶„ì„ ì‹¤í–‰ ì‹œì‘');
    
    // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
    const analysisDiv = document.getElementById('nutrientAnalysis');
    analysisDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading-spinner"></div><p>ì˜ì–‘ë¶„ì„ì„ ì‹¤í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p></div>';
    
    fetch('/mypage/analyze-nutrients/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('ì˜ì–‘ë¶„ì„ ê²°ê³¼:', data);
        if (data.status === 'success') {
            // ë¶„ì„ ê²°ê³¼ ì—…ë°ì´íŠ¸
            updateNutrientAnalysis();
            
            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ (tylko jeÅ›li nie ma danych)
            if (data.message && data.message.includes('ì•„ì§ ì˜ì–‘ì†Œ ì„­ì·¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤')) {
                const successDiv = document.createElement('div');
                successDiv.innerHTML = `<div style="color: #ff9800; padding: 15px; background: #fff3e0; border-radius: 5px; margin: 10px 0;">
                    <strong>â„¹ï¸ ë¶„ì„ ì™„ë£Œ</strong><br>
                    ${data.message}
                </div>`;
                analysisDiv.parentNode.insertBefore(successDiv, analysisDiv.nextSibling);
                
                // 5ì´ˆ í›„ ë©”ì‹œì§€ ì œê±°
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 5000);
            } else {
                // ì¼ë°˜ì ì¸ ì„±ê³µ ë©”ì‹œì§€
                const successDiv = document.createElement('div');
                successDiv.innerHTML = `<div style="color: #2e7d32; padding: 15px; background: #e8f5e8; border-radius: 5px; margin: 10px 0;">
                    <strong>âœ… ì˜ì–‘ë¶„ì„ ì™„ë£Œ!</strong><br>
                    ${data.message}
                </div>`;
                analysisDiv.parentNode.insertBefore(successDiv, analysisDiv.nextSibling);
                
                // 3ì´ˆ í›„ ì„±ê³µ ë©”ì‹œì§€ ì œê±°
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 3000);
            }
        } else {
            analysisDiv.innerHTML = `<div style="color: #d32f2f; padding: 15px; background: #ffebee; border-radius: 5px; margin: 10px 0;">
                <strong>âŒ ì˜ì–‘ë¶„ì„ ì‹¤íŒ¨</strong><br>
                ${data.message}
            </div>`;
        }
    })
    .catch(error => {
        console.error('ì˜ì–‘ë¶„ì„ ì˜¤ë¥˜:', error);
        analysisDiv.innerHTML = `<div style="color: #d32f2f; padding: 15px; background: #ffebee; border-radius: 5px; margin: 10px 0;">
            <strong>âŒ ì„œë²„ ì˜¤ë¥˜</strong><br>
            ì˜ì–‘ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
        </div>`;
    });
}

function updateNutrientAnalysis() {
    console.log('ì˜ì–‘ë¶„ì„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œì‘');
    fetch('/mypage/get-nutrient-data/')
        .then(response => response.json())
        .then(data => {
            console.log('ë°›ì€ ë°ì´í„°:', data);
            if (data.status === 'success') {
                const analysisDiv = document.getElementById('nutrientAnalysis');
                console.log('total_nutrients:', data.data.total_nutrients);
                
                // ë°ì´í„°ê°€ ë¹„ì–´ìˆëŠ” ê²½ìš° ì²˜ë¦¬
                if (!data.data.total_nutrients || Object.keys(data.data.total_nutrients).length === 0) {
                    analysisDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <h3>ğŸ“Š ì˜ì–‘ë¶„ì„ ê²°ê³¼</h3>
                            <p>ì•„ì§ ì˜ì–‘ì†Œ ì„­ì·¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            <p>ì˜ì–‘ì†Œë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ì¢‹ì•„ìš”í•œ ì œí’ˆì„ ë¶ˆëŸ¬ì™€ì„œ ë¶„ì„ì„ ì‹œì‘í•´ë³´ì„¸ìš”.</p>
                        </div>
                    `;
                    return;
                }
                
                const nutrients = JSON.parse(data.data.total_nutrients);
                console.log('íŒŒì‹±ëœ ì˜ì–‘ì†Œ ë°ì´í„°:', nutrients);
                
                let html = '';
                for (const [nutrientName, nutrientData] of Object.entries(nutrients)) {
                    const avgIntake = nutrientData.total / nutrientData.count;
                    const recommended = nutrientData.recommended;
                    const percentage = recommended > 0 ? (avgIntake / recommended) * 100 : 0;
                    
                    console.log(`${nutrientName}: í‰ê·  ì„­ì·¨ëŸ‰=${avgIntake}, ê¶Œì¥ëŸ‰=${recommended}, ë¹„ìœ¨=${percentage}%`);
                    
                    // ê¶Œì¥ëŸ‰ì´ 0ì¸ ê²½ìš° ê²½ê³  í‘œì‹œ
                    if (recommended <= 0) {
                        html += `
                            <div class="nutrient-item">
                                <span class="nutrient-label">${nutrientName}</span>
                                <div class="nutrition-bar">
                                    <div class="nutrition-bar-fill" style="width: 0%; background-color: #ff9800;"></div>
                                </div>
                                <span class="nutrition-percent" style="color: #ff9800;">ê¶Œì¥ëŸ‰ ì—†ìŒ</span>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    ì„­ì·¨ëŸ‰: ${avgIntake.toFixed(1)} (ê¶Œì¥ëŸ‰ ë¯¸ì„¤ì •)
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="nutrient-item">
                                <span class="nutrient-label">${nutrientName}</span>
                                <div class="nutrition-bar">
                                    <div class="nutrition-bar-fill" style="width: ${Math.min(100, percentage)}%"></div>
                                </div>
                                <span class="nutrition-percent">${percentage.toFixed(1)}%</span>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    ì„­ì·¨ëŸ‰: ${avgIntake.toFixed(1)} / ê¶Œì¥ëŸ‰: ${recommended}
                                </div>
                            </div>
                        `;
                    }
                }
                
                analysisDiv.innerHTML = html;
            } else {
                console.error('ì˜ì–‘ë¶„ì„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', data.message);
                document.getElementById('nutrientAnalysis').innerHTML = '<p>ì˜ì–‘ë¶„ì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        })
        .catch(error => {
            console.error('ì˜ì–‘ë¶„ì„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
            document.getElementById('nutrientAnalysis').innerHTML = '<p>ì˜ì–‘ë¶„ì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        });
}

// í˜ì´ì§€ ë¡œë“œì‹œ ì˜ì–‘ì†Œ ì„­ì·¨ ê¸°ë¡ ë¡œë“œ
document.addEventListener('DOMContentLoaded', function() {
    // PoczÄ…tkowo pokaÅ¼ tylko gÅ‚Ã³wne karty
    showMainCards();
    
    // ì˜ì–‘ì†Œ ì„­ì·¨ ê¸°ë¡ ë¡œë“œ
    loadNutrientHistory();
});

// ì˜ì–‘ì†Œ ì„­ì·¨ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸°
async function loadNutrientHistory() {
    try {
        const response = await fetch('/mypage/get-nutrient-history/');
        const data = await response.json();
        
        const historyDiv = document.getElementById('nutrientHistory');
        if (data.status === 'success') {
            const table = createNutrientTable(data.history);
            historyDiv.innerHTML = '';
            historyDiv.appendChild(table);
        } else {
            historyDiv.innerHTML = '<p class="error-message">ì˜ì–‘ì†Œ ì„­ì·¨ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('nutrientHistory').innerHTML = 
            '<p class="error-message">ì˜ì–‘ì†Œ ì„­ì·¨ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
    }
}

// ì§ì ‘ì…ë ¥ ì €ì¥
function submitManualInput() {
    const nutrientName = document.getElementById('nutrientNameInput').value;
    const unit = document.getElementById('unitInput').value;
    const amount = document.getElementById('amountInput').value;
    
    if (nutrientName && unit && amount) {
        fetch('/mypage/add-manual-nutrient/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                nutrient_name: nutrientName,
                unit: unit,
                amount: parseFloat(amount)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('ì˜ì–‘ì†Œ ì„­ì·¨ ê¸°ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeModal('manualInputModal');
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('nutrientNameInput').value = '';
                document.getElementById('unitInput').value = '';
                document.getElementById('amountInput').value = '';
                // ì˜ì–‘ë¶„ì„ê³¼ ê¸°ë¡ ì—…ë°ì´íŠ¸
                updateNutrientAnalysis();
                loadNutrientHistory();
                
                // ìë™ìœ¼ë¡œ ì˜ì–‘ë¶„ì„ í™”ë©´ìœ¼ë¡œ ì´ë™
                showAnalysisResults();
            } else {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì˜ì–‘ì†Œ ì„­ì·¨ ê¸°ë¡ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });
    } else {
        alert('ëª¨ë“  ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    }
}

// ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
function openEditModal(id, amount, date) {
    document.getElementById('editIntakeId').value = id;
    document.getElementById('editAmountInput').value = amount;
    document.getElementById('editDateInput').value = date;
    openModal('editModal');
}

// ì˜ì–‘ì†Œ ì„­ì·¨ ê¸°ë¡ ìˆ˜ì •
function updateNutrientIntake() {
    const id = document.getElementById('editIntakeId').value;
    const amount = document.getElementById('editAmountInput').value;
    const date = document.getElementById('editDateInput').value;
    
    if (amount && date) {
        fetch('/mypage/update-nutrient-intake/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                intake_id: id,
                amount: parseFloat(amount),
                date: date
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('ì˜ì–‘ì†Œ ì„­ì·¨ ê¸°ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeModal('editModal');
                // ì˜ì–‘ë¶„ì„ê³¼ ê¸°ë¡ ì—…ë°ì´íŠ¸
                updateNutrientAnalysis();
                loadNutrientHistory();
            } else {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì˜ì–‘ì†Œ ì„­ì·¨ ê¸°ë¡ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });
    } else {
        alert('ëª¨ë“  ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    }
}

// ì˜ì–‘ì†Œ ì„­ì·¨ ê¸°ë¡ ì‚­ì œ
async function deleteIntake(id) {
    if (!confirm('ì •ë§ë¡œ ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    try {
        const response = await fetch('/mypage/delete-nutrient-intake/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                intake_id: id
            })
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            // ì˜ì–‘ë¶„ì„ê³¼ ê¸°ë¡ ëª¨ë‘ ì—…ë°ì´íŠ¸
            updateNutrientAnalysis();
            loadNutrientHistory();
        } else {
            alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ëª¨ë“  ì˜ì–‘ì†Œ ì„­ì·¨ ê¸°ë¡ ì‚­ì œ
function deleteAllNutrientRecords() {
    if (confirm('ì •ë§ë¡œ ëª¨ë“  ì˜ì–‘ì†Œ ì„­ì·¨ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        fetch('/mypage/delete-all-nutrient-records/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('ëª¨ë“  ì˜ì–‘ì†Œ ì„­ì·¨ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                // ì˜ì–‘ë¶„ì„ê³¼ ê¸°ë¡ ëª¨ë‘ ì—…ë°ì´íŠ¸
                updateNutrientAnalysis();
                loadNutrientHistory();
            } else {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì „ì²´ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });
    }
}

// OCRë¡œ ì¸ì‹ëœ í…ìŠ¤íŠ¸ë¥¼ ì˜ì–‘ë¶„ì„ì— ì¶”ê°€
function saveRawText(rawText) {
    if (confirm('ì¸ì‹ëœ í…ìŠ¤íŠ¸ë¥¼ ì˜ì–‘ë¶„ì„ì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        // í…ìŠ¤íŠ¸ì—ì„œ ì˜ì–‘ì†Œ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì—¬ ì €ì¥
        const nutrients = extractNutrientsFromText(rawText);
        
        if (Object.keys(nutrients).length > 0) {
            // ì¶”ì¶œëœ ì˜ì–‘ì†Œ ì •ë³´ë¥¼ ì €ì¥
            saveExtractedNutrients(nutrients);
        } else {
            // í…ìŠ¤íŠ¸ ìì²´ë¥¼ ì €ì¥
            saveTextAsNote(rawText);
        }
    }
}

// í…ìŠ¤íŠ¸ì—ì„œ ì˜ì–‘ì†Œ ì •ë³´ ì¶”ì¶œ (ê°„ë‹¨í•œ ë²„ì „)
function extractNutrientsFromText(text) {
    const nutrients = {};
    const patterns = [
        /([A-Za-zê°€-í£]+)\s+([\d,\.]+)\s*(mg|g|mcg|Î¼g|iu|ml)/gi,
        /([A-Za-zê°€-í£]+)\s*[:\-]?\s*([\d,\.]+)\s*(mg|g|mcg|Î¼g|iu|ml)/gi
    ];
    
    patterns.forEach(pattern => {
        let match;
        while ((match = pattern.exec(text)) !== null) {
            const nutrientName = match[1].trim();
            const amount = parseFloat(match[2].replace(',', ''));
            const unit = match[3];
            
            if (nutrientName.length > 1 && !isNaN(amount)) {
                nutrients[nutrientName] = `${amount} ${unit}`;
            }
        }
    });
    
    return nutrients;
}

// ì¶”ì¶œëœ ì˜ì–‘ì†Œ ì •ë³´ ì €ì¥
function saveExtractedNutrients(nutrients) {
    fetch('/mypage/save-ocr-ingredients/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            ingredients: nutrients,
            date: new Date().toISOString().split('T')[0]
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('ì˜ì–‘ì†Œ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            updateNutrientAnalysis();
            loadNutrientHistory();
            showAnalysisResults();
        } else {
            alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// í…ìŠ¤íŠ¸ë¥¼ ë©”ëª¨ë¡œ ì €ì¥
function saveTextAsNote(text) {
    // ê°„ë‹¨í•œ ë©”ëª¨ ì €ì¥ (ë‚˜ì¤‘ì— êµ¬í˜„ ê°€ëŠ¥)
    alert('í…ìŠ¤íŠ¸ê°€ ë©”ëª¨ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    showAnalysisResults();
}

// OCRë¡œ ì¸ì‹ëœ ì„±ë¶„ ì €ì¥ (ê¸°ì¡´ í•¨ìˆ˜)
function saveIngredients(ingredients) {
    if (confirm('ì¸ì‹ëœ ì„±ë¶„ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        fetch('/mypage/save-ocr-ingredients/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                ingredients: ingredients,
                date: new Date().toISOString().split('T')[0]  // Today's date
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message);
                // ì˜ì–‘ë¶„ì„ê³¼ ê¸°ë¡ ì—…ë°ì´íŠ¸
                updateNutrientAnalysis();
                loadNutrientHistory();
                
                // ìë™ìœ¼ë¡œ ì˜ì–‘ë¶„ì„ í™”ë©´ìœ¼ë¡œ ì´ë™
                showAnalysisResults();
            } else {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì„±ë¶„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });
    }
}

// ëª¨ë‹¬ ì—´ê¸°
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.style.display = "block";
}

// ëª¨ë‹¬ ë‹«ê¸°
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.style.display = "none";
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    });
}

function showProductDetails(product) {
    const detailsDiv = document.getElementById('product-details');
    if (!product) {
        detailsDiv.innerHTML = '';
        return;
    }
    
    let html = '<h3>ì œí’ˆ ì„±ë¶„</h3><ul>';
    for (const [key, value] of Object.entries(product.ingredients)) {
        html += `<li><strong>${key}</strong>: ${value}</li>`;
    }
    html += '</ul>';
    
    // Add save button
    html += `
        <div style="margin-top: 15px;">
            <button onclick="saveIngredients(${JSON.stringify(product.ingredients).replace(/"/g, '&quot;')})" 
                    style="background: #DDC66F; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">
                ì„±ë¶„ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
            </button>
        </div>
    `;
    
    // Dodaj wyniki sprawdzania przydatnoÅ›ci
    if (product.compatibility) {
        const compatibility = product.compatibility;
        const scoreColor = compatibility.score >= 70 ? '#DDC66F' : 
                          compatibility.score >= 40 ? '#EADCA6' : '#C4A94C';
        
        html += `
            <div class="compatibility-section" style="margin-top: 20px; padding: 15px; border-radius: 8px; background: #f8f9fa; border: 2px solid ${scoreColor};">
                <h4 style="color: ${scoreColor}; margin-bottom: 10px;">
                    í˜¸í™˜ì„± ê²€ì‚¬ ê²°ê³¼ 
                    <span style="font-size: 1.2em; font-weight: bold;">${compatibility.score}%</span>
                </h4>
                
                <div style="margin-bottom: 15px;">
                    <strong>ì í•©ì„±:</strong> 
                    <span style="color: ${compatibility.is_suitable ? '#DDC66F' : '#C4A94C'}; font-weight: bold;">
                        ${compatibility.is_suitable ? 'ì í•©' : 'ë¶€ì í•©'}
                    </span>
                </div>
        `;
        
        if (compatibility.benefits && compatibility.benefits.length > 0) {
            html += '<div style="margin-bottom: 10px;"><strong style="color: #DDC66F;">âœ“ ì¥ì :</strong><ul style="margin: 5px 0; padding-left: 20px;">';
            compatibility.benefits.forEach(benefit => {
                html += `<li style="color: #DDC66F;">${benefit}</li>`;
            });
            html += '</ul></div>';
        }
        
        if (compatibility.warnings && compatibility.warnings.length > 0) {
            html += '<div style="margin-bottom: 10px;"><strong style="color: #C4A94C;">âš  ì£¼ì˜ì‚¬í•­:</strong><ul style="margin: 5px 0; padding-left: 20px;">';
            compatibility.warnings.forEach(warning => {
                html += `<li style="color: #C4A94C;">${warning}</li>`;
            });
            html += '</ul></div>';
        }
        
        if (compatibility.recommendations && compatibility.recommendations.length > 0) {
            html += '<div style="margin-bottom: 10px;"><strong style="color: #EADCA6;">ğŸ’¡ ì¶”ì²œì‚¬í•­:</strong><ul style="margin: 5px 0; padding-left: 20px;">';
            compatibility.recommendations.forEach(recommendation => {
                html += `<li style="color: #EADCA6;">${recommendation}</li>`;
            });
            html += '</ul></div>';
        }
        
        html += '</div>';
    }
    
    detailsDiv.innerHTML = html;
}

// ì˜ì–‘ì†Œ ì„­ì·¨ ê¸°ë¡ í…Œì´ë¸” ìƒì„±
function createNutrientTable(data) {
    const table = document.createElement('table');
    table.className = 'history-table';
    
    // í…Œì´ë¸” í—¤ë”
    const thead = document.createElement('thead');
    thead.innerHTML = `
        <tr>
            <th>ì˜ì–‘ì†Œ</th>
            <th>ì…ë ¥ìˆ˜ëŸ‰</th>
            <th>ë“±ë¡ì¼</th>
            <th>ì‘ì—…</th>
        </tr>
    `;
    table.appendChild(thead);
    
    // í…Œì´ë¸” ë°”ë””
    const tbody = document.createElement('tbody');
    data.forEach(item => {
        const amount = (item.amount !== undefined && item.amount !== null && item.amount !== 0) ? item.amount : '';
        const unit = item.unit ? item.unit : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${item.nutrient_name}</td>
            <td>${amount}${unit}</td>
            <td>${new Date(item.created_at).toLocaleDateString()}</td>
            <td>
                <button class="btn-edit" onclick="editIntake(${item.id}, '${item.nutrient_name}', ${item.amount}, '${item.unit}')">ìˆ˜ì •</button>
                <button class="btn-delete" onclick="deleteIntake(${item.id})">ì‚­ì œ</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    
    return table;
}

// ëª¨ë‹¬ ê´€ë ¨ ë³€ìˆ˜
const modal = document.getElementById('editModal');
const closeBtn = document.getElementsByClassName('close')[0];
const editForm = document.getElementById('editForm');

// ëª¨ë‹¬ ë‹«ê¸°
closeBtn.onclick = function() {
    modal.style.display = "none";
}

// ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
function editIntake(id, nutrientName, amount, unit) {
    document.getElementById('intakeId').value = id;
    document.getElementById('editNutrient').value = nutrientName;
    document.getElementById('editAmountInput').value = amount;
    document.getElementById('editUnitInput').value = unit;
    modal.style.display = "block";
}

// ì˜ì–‘ì†Œ ì„­ì·¨ ìˆ˜ì •
editForm.onsubmit = async function(e) {
    e.preventDefault();
    
    const id = document.getElementById('intakeId').value;
    const nutrient = document.getElementById('editNutrient').value;
    const amount = document.getElementById('editAmountInput').value;
    const unit = document.getElementById('editUnitInput').value;
    
    try {
        const response = await fetch('/mypage/update-nutrient-intake/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                intake_id: id,
                nutrient: nutrient,
                amount: parseFloat(amount),
                unit: unit
            })
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            modal.style.display = "none";
            // ì˜ì–‘ë¶„ì„ê³¼ ê¸°ë¡ ëª¨ë‘ ì—…ë°ì´íŠ¸
            updateNutrientAnalysis();
            loadNutrientHistory();
        } else {
            alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// OCR ê²°ê³¼ë¥¼ ì˜ì–‘ë¶„ì„ì— ìë™ ì €ì¥í•˜ëŠ” í•¨ìˆ˜
function saveOcrIngredientsToAnalysis(ingredients) {
    console.log('Saving OCR ingredients to analysis:', ingredients);
    
    // ê° ì˜ì–‘ì†Œë¥¼ ê°œë³„ì ìœ¼ë¡œ ì €ì¥
    const savePromises = [];
    
    for (const [nutrientName, amountInfo] of Object.entries(ingredients)) {
        // amountInfo format: "100 mg" ë˜ëŠ” "10,000 mcg"
        try {
            const parts = amountInfo.split(' ');
            if (parts.length >= 2) {
                const amountStr = parts[0].replace(',', ''); // ì½¤ë§ˆ ì œê±°
                const unit = parts[1];
                const amount = parseFloat(amountStr);
                
                if (!isNaN(amount)) {
                    console.log(`Saving nutrient: ${nutrientName} = ${amount} ${unit}`);
                    
                    const savePromise = fetch('/mypage/add-manual-nutrient/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            nutrient_name: nutrientName,
                            unit: unit,
                            amount: amount
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            console.log(`Successfully saved ${nutrientName}`);
                            return { success: true, nutrient: nutrientName };
                        } else {
                            console.error(`Failed to save ${nutrientName}:`, data.message);
                            return { success: false, nutrient: nutrientName, error: data.message };
                        }
                    })
                    .catch(error => {
                        console.error(`Error saving ${nutrientName}:`, error);
                        return { success: false, nutrient: nutrientName, error: error.message };
                    });
                    
                    savePromises.push(savePromise);
                }
            }
        } catch (error) {
            console.error(`Error parsing ${nutrientName}:`, error);
        }
    }
    
    // ëª¨ë“  ì €ì¥ ì‘ì—…ì´ ì™„ë£Œëœ í›„ ê²°ê³¼ í™•ì¸
    Promise.all(savePromises).then(results => {
        const successCount = results.filter(r => r.success).length;
        const totalCount = results.length;
        
        console.log(`OCR ì˜ì–‘ì†Œ ì €ì¥ ì™„ë£Œ: ${successCount}/${totalCount} ì„±ê³µ`);
        
        if (successCount > 0) {
            // ì˜ì–‘ë¶„ì„ê³¼ ê¸°ë¡ ì—…ë°ì´íŠ¸
            updateNutrientAnalysis();
            loadNutrientHistory();
        }
    });
}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Pobierz dane o skÅ‚adnikach odÅ¼ywczych
    fetch('/mypage/get-nutrient-data/')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Przygotuj dane do wykresu
                const labels = Object.keys(data.nutrients);
                const actualValues = labels.map(nutrient => data.nutrients[nutrient].actual_amount);
                const recommendedValues = labels.map(nutrient => data.nutrients[nutrient].recommended_amount);

                // StwÃ³rz wykres
                const ctx = document.getElementById('nutrientChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'ì‹¤ì œ ì„­ì·¨ëŸ‰',
                                data: actualValues,
                                backgroundColor: 'rgba(221, 198, 111, 0.5)',
                                borderColor: 'rgba(221, 198, 111, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'ê¶Œì¥ ì„­ì·¨ëŸ‰',
                                data: recommendedValues,
                                backgroundColor: 'rgba(196, 169, 76, 0.5)',
                                borderColor: 'rgba(196, 169, 76, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
});
</script>

<script>
const nutrients = [
  "ë¹„íƒ€ë¯¼ A", "ë² íƒ€ì¹´ë¡œí‹´", "ë¹„íƒ€ë¯¼ D", "ë¹„íƒ€ë¯¼ E", "ë¹„íƒ€ë¯¼ K",
  "ë¹„íƒ€ë¯¼ B1", "ë¹„íƒ€ë¯¼ B2", "ë‚˜ì´ì•„ì‹ ", "íŒí† í…ì‚°", "ë¹„íƒ€ë¯¼ B6",
  "ì—½ì‚°", "ë¹„íƒ€ë¯¼ B12", "ë¹„ì˜¤í‹´", "ë¹„íƒ€ë¯¼ C", "ì¹¼ìŠ˜", "ë§ˆê·¸ë„¤ìŠ˜",
  "ì² ", "ì•„ì—°", "êµ¬ë¦¬", "ì…€ë ˆëŠ„", "ìš”ì˜¤ë“œ", "ë§ê°„", "ëª°ë¦¬ë¸Œë´",
  "ì¹¼ë¥¨", "í¬ë¡¬", "ë£¨í…Œì¸", "ì¸", "ë©”í‹°ì˜¤ë‹Œ", "ì‹œìŠ¤í…Œì¸", "ë¥˜ì‹ ",
  "íŠ¸ë¦½í† íŒ", "ì´ì†Œë¥˜ì‹ ", "ë¼ì´ì‹ ", "íŠ¸ë ˆì˜¤ë‹Œ", "í˜ë‹ì•Œë¼ë‹Œ", "í‹°ë¡œì‹ "
];

const nutrientInput = document.getElementById('nutrientNameInput');
const list = document.getElementById('autocomplete-list');

nutrientInput.addEventListener('input', function() {
  const value = this.value.trim();
  list.innerHTML = '';
  if (!value) {
    list.style.display = 'none';
    return;
  }
  const filtered = nutrients.filter(n => n.includes(value));
  if (filtered.length === 0) {
    list.style.display = 'none';
    return;
  }
  filtered.forEach(nutrient => {
    const li = document.createElement('li');
    li.textContent = nutrient;
    li.style.cursor = 'pointer';
    li.style.padding = '6px 10px';
    li.onmouseover = function() { li.style.background = '#f0f0f0'; };
    li.onmouseout = function() { li.style.background = 'white'; };
    li.onclick = function() {
      nutrientInput.value = nutrient;
      list.style.display = 'none';
    };
    list.appendChild(li);
  });
  list.style.display = 'block';
});

// ëª¨ë‹¬ì´ ë‹«í ë•Œ ìë™ì™„ì„± ë¦¬ìŠ¤íŠ¸ë„ ë‹«ê¸°
const manualModal = document.getElementById('manualInputModal');
manualModal.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal')) {
    list.style.display = 'none';
  }
});

// ì…ë ¥ë€ ì´ì™¸ í´ë¦­ ì‹œ ìë™ì™„ì„± ë‹«ê¸° (ë¦¬ìŠ¤íŠ¸ í´ë¦­ í—ˆìš©)
document.addEventListener('click', function(e) {
  if (e.target !== nutrientInput && !list.contains(e.target)) {
    list.style.display = 'none';
  }
});
</script>
{% endblock %} 