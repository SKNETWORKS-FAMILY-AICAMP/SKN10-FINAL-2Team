{% extends 'Mypage/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/Mypage/header.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/Mypage/analysis.css' %}">
{% endblock %}

{% block content %}
<div id="favoriteModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('favoriteModal')">&times;</span>
        <h2>좋아요한 영양제</h2>
        <p>등록할 영양제를 선택하세요.</p>
        <div id="favorite-products-grid" class="favorite-products-grid">
            </div>
        <button onclick="registerSelection()" class="register-button">선택 영양제 등록하기</button>
    </div>
</div>

<div class="my_healthy">
    <div class="card-row-flex">
        <!-- Lewa karta -->
        <div class="card-box left-card">
            <div class="title">영양제 추가하기</div>
            <input type="file" id="ocr-upload" accept="image/*" style="display:none" onchange="handleOcrUpload(event)">
            <div class="upload-box" onclick="document.getElementById('ocr-upload').click()">
                <span>이미지 업로드하기</span>
            </div>
            <div class="upload-box" onclick="loadFavoriteProducts()">
                <span>좋아요한 영양제 불러오기</span>
            </div>
            <div class="upload-box" onclick="showManualInput()">
                <span>직접 입력하기</span>
            </div>
            <div id="product-details" class="product-details">
                
            </div>
            <div id="ocr-error" style="color:red; margin-top:10px;"></div>
        </div>

        <!-- Prawa karta -->
        <div class="card-box right-card">
            <div class="title">{{ user.name }}님의 영양분석</div>
            <div class="product-image-line"></div>
            <div class="intake-products-container">
                <h3>섭취 중인 영양제</h3>
                <div id="intakeProductImageList" class="product-image-list">
                    </div>
            </div>
            <div class="product-image-line"></div>
            <div class="result-content">
                <h2>권장섭취량 대비 섭취량 분석</h2>
                <div id="nutrientBarContainer"></div>
            </div>
        </div>
    </div>
</div>

<!-- 이미지 업로드 모달 -->
<div id="imageUploadModal" class="modal">
    <div class="modal-content">
        <h2>이미지 업로드</h2>
        <input type="file" id="imageInput" accept="image/*">
        <button onclick="uploadImage()">업로드</button>
        <button onclick="closeModal('imageUploadModal')">취소</button>
    </div>
</div>

<!-- 직접 입력 모달 -->
<div id="manualInputModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('manualInputModal')">&times;</span>
        <h2>영양소 직접 입력</h2>
        
        <div>
            <label for="nutrientSelect">영양소 선택</label>
            <select id="nutrientSelect">
                <option value="류신">류신</option>
                <option value="이소류신">이소류신</option>
                <option value="발린">발린</option>
                <option value="라이신">라이신</option>
                <option value="페닐알라닌">페닐알라닌</option>
                <option value="트레오닌">트레오닌</option>
                <option value="트립토판">트립토판</option>
                <option value="히스티딘">히스티딘</option>
                <option value="비타민 A">비타민A</option>
                <option value="비타민 D">비타민D</option>
                <option value="비타민 E">비타민E</option>
                <option value="비타민 K">비타민K</option>
                <option value="비타민 C">비타민C</option>
                <option value="비타민 B1">비타민B1</option>
                <option value="비타민 B2">비타민B2</option>
                <option value="니아신">니아신</option>
                <option value="비타민 B6">비타민B6</option>
                <option value="엽산">엽산</option>
                <option value="비타민 B12">비타민B12</option>
                <option value="판토텐산">판토텐산</option>
                <option value="비오틴">비오틴</option>
                <option value="칼슘">칼슘</option>
                <option value="인">인</option>
                <option value="나트륨">나트륨</option>
                <option value="염소">염소</option>
                <option value="칼륨">칼륨</option>
                <option value="마그네슘">마그네슘</option>
                <option value="철">철</option>
                <option value="아연">아연</option>
                <option value="구리">구리</option>
                <option value="불소">불소</option>
                <option value="망간">망간</option>
                <option value="요오드">요오드</option>
                <option value="셀레늄">셀레늄</option>
                <option value="몰리브덴">몰리브덴</option>
                <option value="크롬">크롬</option>
            </select>
        </div>

        <div>
            <label for="amountInput">섭취량 (mg 또는 μg)</label>
            <input type="number" id="amountInput" min="0" step="0.01">
        </div>

        <button onclick="saveManualInput()">저장</button>
        <button onclick="closeModal('manualInputModal')">취소</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>

// CSRF 토큰 가져오기
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 이미지 업로드 처리
function handleOcrUpload(event) {
    const file = event.target.files[0];
    console.log('Plik wybrany:', file);
    if (!file) return;
    const formData = new FormData();
    formData.append('image', file);
    document.getElementById('ocr-error').innerText = '';
    fetch('/mypage/ocr_extract/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => {
        console.log('OCR response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Odpowiedź OCR:', data);
        if (data.status === 'success') {
            showProductDetails({ingredients: data.ingredients});
        } else if (data.status === 'debug') {
            document.getElementById('ocr-error').innerText = 'OCR raw text: ' + (data.raw_text || 'brak');
        } else {
            document.getElementById('ocr-error').innerText = data.message || '성분 인식에 실패했습니다.';
        }
    })
    .catch((err) => {
        document.getElementById('ocr-error').innerText = '서버 오류가 발생했습니다.';
        console.error('OCR fetch error:', err);
    });
}

// Dodaj zmienne dla modalu
const modal = document.getElementById("favoriteModal");
const span = document.getElementsByClassName("close")[0];

// Zamknij modal po kliknięciu X
span.onclick = function() {
    modal.style.display = "none";
}

// Zamknij modal po kliknięciu poza nim
window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

// ✨ 좋아요한 영양제 목록 불러오기 (수정)
function loadFavoriteProducts() {
    fetch("{% url 'mypage:get_liked_products' %}")
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const grid = document.getElementById('favorite-products-grid');
                grid.innerHTML = ''; // 기존 목록 비우기

                data.products.forEach(product => {
                    const item = document.createElement('div');
                    item.className = 'product-item';
                    item.dataset.productId = product.id; // 상품 ID를 data 속성에 저장
                    item.onclick = function() { toggleProductSelection(this); };
                    
                    item.innerHTML = `
                        <img src="${product.image_url}" alt="${product.name}">
                        <p>${product.name}</p>
                    `;
                    grid.appendChild(item);
                });

                document.getElementById('favoriteModal').style.display = 'block';
            } else {
                alert('좋아요 목록을 불러오는데 실패했습니다.');
            }
        })
        .catch(error => console.error('Error:', error));
}
// ✨ 모달에서 상품 선택/해제 토글 함수
function toggleProductSelection(element) {
    // 다중 선택이 아닌 단일 선택으로 구현
    const selected = document.querySelector('.product-item.selected');
    if (selected) {
        selected.classList.remove('selected');
    }
    element.classList.add('selected');
}
function registerSelection() {
    const selectedItem = document.querySelector('.product-item.selected');
    if (!selectedItem) {
        alert('등록할 영양제를 선택해주세요.');
        return;
    }
    
    const productId = selectedItem.dataset.productId;

    fetch("{% url 'mypage:register_liked_product' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ product_id: productId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(data.message);
            // UI 업데이트
            addIntakeProductImage(data.added_product_image_url);
            // 영양 분석 그래프/바 업데이트 함수 호출 (이전 답변에서 사용)
            // renderNutrientGraph(); 
            closeModal('favoriteModal');
        } else {
            alert('등록에 실패했습니다: ' + data.message);
        }
    })
    .catch(error => console.error('Error:', error));
}

function addIntakeProductImage(imageUrl) {
    const listContainer = document.getElementById('intakeProductImageList');
    const img = document.createElement('img');
    img.src = imageUrl;
    listContainer.appendChild(img);
}

// 직접 입력 모달
function showManualInput() {
    const modal = document.getElementById('manualInputModal');
    modal.style.display = 'block';
}
function saveManualInput() {
    const nutrient = document.getElementById('nutrientSelect').value;
    const amount = document.getElementById('amountInput').value;

    if (!amount || isNaN(amount)) {
        alert("섭취량을 올바르게 입력해주세요.");
        return;
    }

    const dataToSave = {
        nutrient_name: nutrient,
        amount: amount
    };

    fetch("{% url 'mypage:save_user_nutrients' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(dataToSave)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(data.message);
            closeModal('manualInputModal');
            renderNutrientGraph(); // 저장 후 그래프 다시 그림
        } else {
            alert('저장 실패: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('서버 오류가 발생했습니다.');
    });
}

// 모달 닫기
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.style.display = 'none';

}
// 모달 외부 클릭 시 닫기
window.onclick = function(event) {
    const favoriteModal = document.getElementById('favoriteModal');
    const manualInputModal = document.getElementById('manualInputModal');
    if (event.target == favoriteModal) {
        favoriteModal.style.display = "none";
    }
    if (event.target == manualInputModal) {
        manualInputModal.style.display = "none";
    }
}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

function showProductDetails(product) {
    const detailsDiv = document.getElementById('product-details');
    if (!product) {
        detailsDiv.innerHTML = '';
        return;
    }
    let html = '<h3>제품 성분</h3><ul>';
    for (const [key, value] of Object.entries(product.ingredients)) {
        html += `<li><strong>${key}</strong>: ${value}</li>`;
    }
    html += '</ul>';
    detailsDiv.innerHTML = html;
}

// 차트 관련 스크립트
let nutrientChart = null; // 차트 객체를 저장할 변수
function renderNutrientGraph() {
    fetch("/mypage/get_nutrient_data/")
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                renderProgressBars(data.labels, data.intake_percentages);
            } else {
                console.error('그래프 데이터 로딩 실패');
            }
        })
        .catch(error => {
            console.error('그래프 데이터 통신 오류:', error);
        });
}

function renderProgressBars(labels, percentages) {
    const container = document.getElementById('nutrientBarContainer');
    container.innerHTML = ''; // 초기화

    labels.forEach((label, index) => {
        const percent = percentages[index];

        const wrapper = document.createElement('div');
        wrapper.className = 'nutrient-bar-wrapper';

        const labelDiv = document.createElement('div');
        labelDiv.className = 'nutrient-label';
        labelDiv.innerHTML = `<span>${label}</span><span>${percent}%</span>`;

        const barBg = document.createElement('div');
        barBg.className = 'nutrient-bar-bg';

        const barFill = document.createElement('div');
        barFill.className = 'nutrient-bar-fill';
        barFill.style.width = `${Math.min(percent, 100)}%`; // 100% 초과 방지

        barBg.appendChild(barFill);
        wrapper.appendChild(labelDiv);
        wrapper.appendChild(barBg);
        container.appendChild(wrapper);
    });
}



document.addEventListener('DOMContentLoaded', renderNutrientGraph);
</script>
{% endblock %} 