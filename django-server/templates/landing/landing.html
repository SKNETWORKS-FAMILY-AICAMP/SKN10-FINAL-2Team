<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/landing.css' %}">
</head>
<body>
  <header>
    <nav>
      {% load static %}
        <a class="Logo" href="/">
          <img src="{% static 'image/Logo.png' %}" alt="Logo">
        </a>
      <ul>
        <li><a id="chatbot-link" href="">챗봇</a></li>
        <li><a href="#">마이페이지</a></li>
      </ul>
      <a id="auth-button"></a>
    </nav>
  </header>
  <div class="content">
    <div class="top">
      <div class="mt">키워드 만으로<br>영양제를 검색해보세요.</div>
      <form action="search">
        <input type="search" name="q" placeholder="검색어를 입력하세요">
        <span>
          <img src="#" alt="검색 아이콘">
        </span>
      </form>
    </div>

    <div class="bottom">
      <img src="#" alt="">
    </div>
    <div class="recoti">
      <span>항목별 인기 영양제</span>
      <ul>
        <li data-type="cheap">가성비순</li>
        <li data-type="popular">인기순</li>
        <li data-type="sales">판매량순</li>
      </ul>
    </div>
    <div class="prolist" id="prolist">
      {% for product in products|slice:":5" %}
      <a href="{{ product.url }}" target="_blank">
      <img src="{{ product.image_link|default:'https://via.placeholder.com/150' }}" alt="{{ product.title }}" >
      </a>
      {% endfor %}
    </div>

    </div>
    <div>
      <img src="#" alt="">
    </div>
  </div>

  <footer>
    <!-- Footer 내용 -->
  </footer>

  <script type="module">
    const accessToken = localStorage.getItem("accessToken");
    if (accessToken) {
      console.log("✅ 로그인 상태 유지됨");
      // 이 토큰을 이용해 API 요청 등 처리 가능
    } else {
      console.warn("❗ 로그인되지 않음");
    }
    // 상품리스트탭
    import { checkUserAuthentication, logoutUser, redirectToLogin } from '{% static "js/auth.js" %}';
    document.querySelectorAll('.recoti li').forEach(li => {
      if (li.textContent.trim() === '가성비순') {
        li.addEventListener('click', () => {
          fetch('/get_weighted_scores/', {
            headers: {'X-Requested-With': 'XMLHttpRequest'}
          })
          .then(res => res.json())
          .then(data => {
            const target = document.querySelector('.prolist');
            target.innerHTML = '';
            data.results.forEach(item => {
              const el = document.createElement('div');
              el.className = 'pro-item';
              el.innerHTML = `<strong>${item.title}</strong><br>평점: ${item.average_rating} | 가격: ${item.price} | 점수: ${item.score.toFixed(3)}`;
              target.appendChild(el);
            });
          });
        });
      }
    });
    // 상품리스트탭 끝
    async function updateAuthButton() {
        const authButton = document.getElementById('auth-button');

        if (!authButton) {
            console.warn("Authentication button not found.");
            return;
        }
        const userisAuthenticated = await checkUserAuthentication();
        if (userisAuthenticated) {
            
            authButton.textContent = '로그아웃';
            authButton.onclick = logoutUser; // Assign the imported logout function
        } else {
            
            authButton.textContent = '로그인';
            authButton.onclick = redirectToLogin; // Assign the imported redirect function
        }
    }
    async function setupChatbotLink() {
        const chatbotLink = document.getElementById('chatbot-link');
        if (!chatbotLink) {
            console.warn("Chatbot link not found.");
            return;
        }

        chatbotLink.addEventListener('click', async function(event) {
          event.preventDefault(); // 기본 동작 방지

          // 클릭하는 시점에 인증 상태를 확인합니다.
          const userIsAuthenticated = await checkUserAuthentication();

          if (userIsAuthenticated) {
              console.log("User is logged in, redirecting to chatbot page.");
              window.location.href = '/Chatbot/ChatWithNuti/';
          } else {
              console.log("User not logged in, redirecting to login page.");
              // checkUserAuthentication 내부에서 이미 로그아웃 처리 및 알림을 할 수 있으므로,
              // 경우에 따라 여기서는 로그인 페이지로 보내기만 해도 됩니다.
              window.location.href = '/login/';
          }
        });
    }

    // Call both setup functions when the DOM is loaded
    document.addEventListener('DOMContentLoaded', async () => {
        await updateAuthButton(); // Ensure button is updated first
        await setupChatbotLink(); // Then set up the chatbot link's behavior
    });
  </script>

</body>
</html>
